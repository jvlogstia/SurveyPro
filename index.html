<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SurveyCraft Pro | Connect + Dashboard</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { inter: ["Inter", "ui-sans-serif", "system-ui"] },
          colors: {
            primary: { 50:'#eef2ff',100:'#e0e7ff',200:'#c7d2fe',300:'#a5b4fc',400:'#818cf8',500:'#6366f1',600:'#4f46e5',700:'#4338ca',800:'#3730a3',900:'#312e81' },
            accent:   { 50:'#faf5ff',100:'#f3e8ff',200:'#e9d5ff',300:'#d8b4fe',400:'#c084fc',500:'#a855f7',600:'#9333ea',700:'#7e22ce',800:'#6b21a8',900:'#581c87' },
            ink:      { 50:'#f8fafc',100:'#f1f5f9',200:'#e2e8f0',300:'#cbd5e1',400:'#94a3b8',500:'#64748b',600:'#475569',700:'#334155',800:'#1e293b',900:'#0f172a' },
            success:'#22c55e', danger:'#ef4444', warning:'#f59e0b'
          },
          boxShadow: { glow: '0 10px 40px rgba(99,102,241,.25)' },
          keyframes: {
            fadeup: { '0%': { opacity: 0, transform: 'translateY(14px)' }, '100%': { opacity: 1, transform: 'translateY(0)' } },
            float:  { '0%': { transform: 'translateY(0) translateX(0)' }, '50%': { transform: 'translateY(-8px) translateX(4px)' }, '100%': { transform: 'translateY(0) translateX(0)' } },
            fade:   { '0%': { opacity: 0 }, '100%': { opacity: 1 } }
          },
          animation: { fadeup: 'fadeup .45s ease-out both', float: 'float 6s ease-in-out infinite', fade:'fade .25s ease-out both' }
        }
      }
    }
  </script>

  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

  <!-- Charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    html,body{height:100%}
    body{font-family:'Inter',sans-serif;background:radial-gradient(1200px 600px at 10% 10%, rgba(99,102,241,.10), transparent 60%), radial-gradient(900px 500px at 90% 0%, rgba(168,85,247,.08), transparent 50%), #0b1020;color:#e5e7eb}
    .glass{backdrop-filter:blur(16px) saturate(160%); background:rgba(17,24,39,.66); border:1px solid rgba(255,255,255,.08)}
    .card{background:rgba(17,24,39,.78); border:1px solid rgba(255,255,255,.08); border-radius:16px}
    .field{background:rgba(255,255,255,.06); border:1px solid transparent; border-radius:12px; padding:.7rem 1rem; transition:.2s}
    .field:focus{outline:none; border-color:rgba(99,102,241,.6); box-shadow:0 0 0 4px rgba(99,102,241,.20)}
    .btn{position:relative; display:inline-flex; align-items:center; justify-content:center; gap:.5rem; border-radius:12px; padding:.7rem 1rem; font-weight:600; transition:transform .15s, box-shadow .15s, background .2s}
    .btn-primary{background:linear-gradient(90deg,#6366f1,#8b5cf6); color:white}
    .btn-primary:hover{transform:translateY(-1px); box-shadow:0 10px 30px rgba(99,102,241,.25)}
    .btn-ghost{background:rgba(255,255,255,.04); color:#e5e7eb; border:1px solid rgba(255,255,255,.08)}
    .btn-ghost:hover{background:rgba(255,255,255,.06)}
    .nav-item{display:flex; align-items:center; gap:.75rem; padding:.75rem .9rem; border-radius:12px; color:#e5e7eb; transition:.2s}
    .nav-item:hover{background:rgba(99,102,241,.12)}
    .nav-item.active{background:rgba(99,102,241,.18); color:#c7d2fe}
    .empty{border:1px dashed rgba(255,255,255,.18); background:rgba(255,255,255,.03); border-radius:12px}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
    .toggle{position:relative;width:50px;height:24px}
    .toggle input{opacity:0;width:0;height:0}
    .toggle .slider{position:absolute;inset:0;background:rgba(255,255,255,.1);border-radius:24px;transition:.3s}
    .toggle .slider:before{content:"";position:absolute;height:16px;width:16px;left:4px;bottom:4px;background:#fff;border-radius:50%;transition:.3s}
    .toggle input:checked + .slider{background:#6366f1}
    .toggle input:checked + .slider:before{transform:translateX(26px)}
    .builder-grid{display:grid; grid-template-columns:280px 1fr; gap:1rem}
    @media (max-width: 1024px){.builder-grid{grid-template-columns:1fr}}
    .toast{position:fixed; bottom:20px; right:20px; padding:.75rem 1.25rem; background:rgba(17,24,39,.95); border-radius:10px; border:1px solid rgba(255,255,255,.1); z-index:1000; opacity:0; transform:translateY(20px); transition:opacity .3s, transform .3s}
    .toast.show{opacity:1; transform:translateY(0)}
    .route{animation:fade .25s ease-out}
    .ripple{position:absolute; border-radius:50%; transform:scale(0); animation:rip 600ms linear; background:rgba(255,255,255,.4)}
    @keyframes rip{to{transform:scale(4); opacity:0}}
  </style>
</head>
<body>
  <div class="pointer-events-none fixed inset-x-0 -top-24 h-48 bg-gradient-to-b from-primary-500/20 to-transparent blur-3xl"></div>

  <!-- Toast notification -->
  <div id="toast" class="toast hidden"></div>

  <!-- AUTH -->
  <section id="auth" class="min-h-screen grid place-items-center p-6">
    <div class="card w-full max-w-lg p-8 animate-fadeup shadow-glow">
      <div class="w-14 h-14 rounded-2xl bg-gradient-to-br from-primary-500 to-accent-500 grid place-items-center mb-5 animate-float">
        <i class="fa-solid fa-link text-white"></i>
      </div>
      <h1 class="text-2xl font-semibold" data-i18n="auth_title">Connect to SurveyCraft Pro</h1>
      <p class="text-ink-400 mt-1" data-i18n="auth_sub">Sign in to continue.</p>

      <div class="mt-6 grid grid-cols-2 gap-2 bg-white/5 p-1 rounded-xl">
        <button id="tab-login" class="tab btn-ghost py-2 rounded-lg data-[active=true]:bg-primary-500/20" data-active="true" data-i18n="login">Login</button>
        <button id="tab-signup" class="tab btn-ghost py-2 rounded-lg" data-i18n="signup">Sign Up</button>
      </div>

      <!-- Login -->
      <form id="form-login" class="mt-6 space-y-4" autocomplete="on" method="POST" action="/auth/login">
        <label class="block">
          <span class="block text-sm mb-1" data-i18n="email">Email</span>
          <input type="email" name="email" class="field w-full" placeholder="you@company.com" required />
        </label>
        <label class="block">
          <span class="block text-sm mb-1" data-i18n="password">Password</span>
          <input type="password" name="password" class="field w-full" placeholder="••••••••" required />
        </label>
        <div class="flex items-center justify-between text-sm">
          <label class="inline-flex items-center gap-2 select-none">
            <input type="checkbox" name="remember" class="accent-primary-500" />
            <span data-i18n="remember">Remember me</span>
          </label>
          <a href="#" class="text-primary-300 hover:text-primary-200" data-i18n="forgot">Forgot password?</a>
        </div>
        <button type="submit" class="btn btn-primary w-full" id="btn-login">
          <span class="inline-flex items-center gap-2"><i class="fa-solid fa-right-to-bracket"></i> <span data-i18n="signin">Sign In</span></span>
        </button>
        <p id="login-error" class="hidden text-red-400 text-sm" role="alert" data-i18n="login_err">Authentication failed. Check your credentials.</p>
      </form>

      <!-- Signup -->
      <form id="form-signup" class="mt-6 space-y-4 hidden" autocomplete="on" method="POST" action="/auth/signup">
        <label class="block">
          <span class="block text-sm mb-1" data-i18n="fullname">Full name</span>
          <input type="text" name="name" class="field w-full" placeholder="Your name" required />
        </label>
        <label class="block">
          <span class="block text-sm mb-1" data-i18n="email">Email</span>
          <input type="email" name="email" class="field w-full" placeholder="you@company.com" required />
        </label>
        <label class="block">
          <span class="block text-sm mb-1" data-i18n="password">Password</span>
          <input type="password" name="password" class="field w-full" placeholder="Create a password (min 8 chars)" minlength="8" required />
        </label>
        <label class="inline-flex items-center gap-2 text-sm">
          <input type="checkbox" name="terms" required />
          <span data-i18n="agree">I agree to the terms</span>
        </label>
        <button type="submit" class="btn btn-primary w-full" id="btn-signup">
          <span class="inline-flex items-center gap-2"><i class="fa-solid fa-user-plus"></i> <span data-i18n="create">Create Account</span></span>
        </button>
        <p id="signup-error" class="hidden text-red-400 text-sm" role="alert" data-i18n="signup_err">Please verify your details.</p>
      </form>
    </div>
  </section>

  <!-- APP SHELL -->
  <section id="app" class="hidden h-screen">
    <div class="h-full flex">
      <!-- Sidebar -->
      <aside class="glass w-72 p-5 hidden md:block">
        <div class="flex items-center gap-3 mb-8">
          <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-primary-500 to-accent-500 grid place-items-center">
            <i class="fa-solid fa-link text-white"></i>
          </div>
          <div>
            <h2 class="font-semibold">SurveyCraft Pro <span id="gov-badge" class="ml-2 text-xxs text-warning hidden">[GOV]</span></h2>
            <p class="text-xs text-ink-400" data-i18n="connect">Connect</p>
          </div>
        </div>
        <nav class="space-y-1">
          <a href="#" data-route="dashboard" class="nav-item active"><i class="fa-solid fa-gauge-high w-5 text-primary-300"></i><span data-i18n="dashboard">Dashboard</span></a>
          <a href="#" data-route="surveys"   class="nav-item"><i class="fa-solid fa-square-poll-vertical w-5"></i><span data-i18n="surveys">Surveys</span></a>
          <a href="#" data-route="builder"   class="nav-item"><i class="fa-solid fa-wand-magic-sparkles w-5"></i><span data-i18n="builder">Builder</span></a>
          <a href="#" data-route="share"     class="nav-item"><i class="fa-solid fa-share-nodes w-5"></i><span data-i18n="share">Share</span></a>
          <a href="#" data-route="analytics" class="nav-item"><i class="fa-solid fa-chart-simple w-5"></i><span data-i18n="analytics">Analytics</span></a>
          <a href="#" data-route="audience"  class="nav-item"><i class="fa-solid fa-users w-5"></i><span data-i18n="audience">Audience</span></a>
          <a href="#" data-route="settings"  class="nav-item"><i class="fa-solid fa-gear w-5"></i><span data-i18n="settings">Settings</span></a>
        </nav>
        <div class="mt-10 pt-6 border-t border-white/10">
          <form method="POST" action="/auth/logout">
            <button type="submit" class="btn btn-ghost w-full"><i class="fa-solid fa-right-from-bracket"></i> <span data-i18n="logout">Logout</span></button>
          </form>
        </div>
      </aside>

      <!-- Main -->
      <main class="flex-1 overflow-y-auto p-6">
        <!-- Header -->
        <header class="flex items-center justify-between mb-6">
          <div>
            <h1 class="text-xl font-semibold" id="route-title">Overview</h1>
            <p class="text-ink-400 text-sm" id="route-description">Bring your data — we keep the UI clean.</p>
          </div>
          <div class="flex items-center gap-3">
            <!-- Language Selector -->
            <div class="relative" id="lang-container">
              <button class="btn btn-ghost flex items-center gap-2" id="lang-toggle" aria-haspopup="true" aria-expanded="false">
                <span id="current-lang">English</span>
                <i class="fa-solid fa-chevron-down text-xs"></i>
              </button>
              <div class="absolute top-full right-0 mt-2 w-52 card p-2 hidden z-10" id="lang-menu" role="menu" aria-label="Language menu">
                <button class="w-full text-left px-3 py-2 rounded-lg hover:bg-white/5 language-option" data-lang="en">🇺🇸 English</button>
                <button class="w-full text-left px-3 py-2 rounded-lg hover:bg-white/5 language-option" data-lang="hi">🇮🇳 हिन्दी</button>
                <button class="w-full text-left px-3 py-2 rounded-lg hover:bg-white/5 language-option" data-lang="es">🇪🇸 Español</button>
                <button class="w-full text-left px-3 py-2 rounded-lg hover:bg-white/5 language-option" data-lang="fr">🇫🇷 Français</button>
                <button class="w-full text-left px-3 py-2 rounded-lg hover:bg-white/5 language-option" data-lang="de">🇩🇪 Deutsch</button>
              </div>
            </div>

            <div class="relative">
              <i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-ink-400"></i>
              <input id="global-search" class="field pl-10 w-64" placeholder="Search" />
            </div>
            <div class="w-10 h-10 rounded-full bg-white/10 grid place-items-center" aria-label="Profile">
              <i class="fa-solid fa-user text-ink-300"></i>
            </div>
          </div>
        </header>

        <!-- Route: Dashboard -->
        <section id="route-dashboard" class="route space-y-6">
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
            <div class="card p-5 animate-fadeup">
              <div class="flex items-center justify-between mb-2">
                <div class="text-ink-400 text-sm" data-i18n="kpi_surveys">Surveys</div>
                <i class="fa-solid fa-square-poll-vertical text-primary-400"></i>
              </div>
              <div class="text-2xl font-semibold mt-1" id="kpi-surveys">0</div>
            </div>
            <div class="card p-5 animate-fadeup" style="animation-delay:.05s">
              <div class="flex items-center justify-between mb-2">
                <div class="text-ink-400 text-sm" data-i18n="kpi_responses">Responses</div>
                <i class="fa-solid fa-reply text-primary-400"></i>
              </div>
              <div class="text-2xl font-semibold mt-1" id="kpi-responses">0</div>
            </div>
            <div class="card p-5 animate-fadeup" style="animation-delay:.1s">
              <div class="flex items-center justify-between mb-2">
                <div class="text-ink-400 text-sm" data-i18n="kpi_completion">Completion Rate</div>
                <i class="fa-solid fa-percent text-primary-400"></i>
              </div>
              <div class="text-2xl font-semibold mt-1" id="kpi-completion">0%</div>
              <div class="mt-2 w-full h-2 rounded bg-white/10"><div id="completion-progress" class="h-2 rounded bg-primary-500" style="width:0%"></div></div>
            </div>
            <div class="card p-5 animate-fadeup" style="animation-delay:.15s">
              <div class="flex items-center justify-between mb-2">
                <div class="text-ink-400 text-sm" data-i18n="kpi_active">Active Now</div>
                <i class="fa-solid fa-users text-primary-400"></i>
              </div>
              <div class="text-2xl font-semibold mt-1" id="kpi-active">0</div>
            </div>
          </div>

          <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="card p-6 lg:col-span-2">
              <div class="flex items-center justify-between mb-4">
                <h2 class="font-semibold" data-i18n="resp_time">Responses Over Time</h2>
                <div class="flex gap-2">
                  <button class="btn btn-ghost text-sm range-btn" data-range="7d">7d</button>
                  <button class="btn btn-ghost text-sm range-btn" data-range="30d">30d</button>
                  <button class="btn btn-ghost text-sm range-btn" data-range="90d">90d</button>
                </div>
              </div>
              <div class="relative h-72">
                <canvas id="chart-responses" aria-label="Responses chart"></canvas>
                <div id="empty-responses" class="empty absolute inset-0 grid place-items-center text-ink-400 text-sm rounded-xl">
                  <div class="text-center"><i class="fa-solid fa-chart-line text-3xl mb-3 opacity-50"></i><p data-i18n="no_resp">No response data available</p></div>
                </div>
              </div>
            </div>
            <div class="card p-6">
              <div class="flex items-center justify-between mb-4">
                <h2 class="font-semibold" data-i18n="survey_status">Survey Status</h2>
              </div>
              <div class="relative h-72">
                <canvas id="chart-status" aria-label="Status chart"></canvas>
                <div id="empty-status" class="empty absolute inset-0 grid place-items-center text-ink-400 text-sm rounded-xl">
                  <div class="text-center"><i class="fa-solid fa-chart-pie text-3xl mb-3 opacity-50"></i><p data-i18n="no_survey">No survey data available</p></div>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- Route: Surveys -->
        <section id="route-surveys" class="route hidden">
          <div class="flex items-center justify-between mb-6">
            <div>
              <h1 class="text-xl font-semibold" data-i18n="surveys">Surveys</h1>
              <p class="text-ink-400 text-sm" data-i18n="surveys_sub">Create and manage your surveys</p>
            </div>
            <div class="flex items-center gap-3">
              <div class="relative"><i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-ink-400"></i>
                <input id="survey-search" class="field pl-10 w-64" placeholder="Search surveys..." />
              </div>
              <button id="btn-open-create" class="btn btn-primary"><i class="fa-solid fa-plus"></i> <span data-i18n="new_survey">New Survey</span></button>
            </div>
          </div>
          <div id="surveys-list" class="empty p-6 text-ink-400 text-center">
            <i class="fa-solid fa-square-poll-vertical text-3xl mb-3 opacity-50"></i>
            <p data-i18n="no_surveys">No surveys yet</p>
            <p class="text-sm mt-2" data-i18n="start_create">Get started by creating your first survey</p>
            <button class="btn btn-primary mt-4" id="cta-create"><i class="fa-solid fa-plus"></i> <span data-i18n="create_survey">Create Survey</span></button>
          </div>
        </section>

        <!-- Route: Builder -->
        <section id="route-builder" class="route hidden">
          <div class="card p-6">
            <div class="flex items-center justify-between mb-6">
              <div>
                <h2 class="font-semibold" data-i18n="builder">Builder</h2>
                <p class="text-ink-400 text-sm" data-i18n="builder_sub">Drag & drop components to create your survey</p>
              </div>
              <div class="flex gap-2">
                <button class="btn btn-ghost" id="btn-preview"><i class="fa-solid fa-eye"></i> <span data-i18n="preview">Preview</span></button>
                <button class="btn btn-primary" id="save-survey"><i class="fa-solid fa-floppy-disk"></i> <span data-i18n="save">Save</span></button>
              </div>
            </div>

            <div class="builder-grid">
              <div class="card p-5">
                <h3 class="font-medium mb-4" data-i18n="components">Components</h3>
                <p class="text-sm text-ink-400 mb-4" data-i18n="drag_here">Drag components into the canvas</p>
                <div class="space-y-2">
                  <div class="component-item field cursor-move" draggable="true" data-type="text"><i class="fa-solid fa-font text-primary-400 mr-2"></i><span data-i18n="comp_text">Text Question</span></div>
                  <div class="component-item field cursor-move" draggable="true" data-type="multiple"><i class="fa-solid fa-list-ol text-primary-400 mr-2"></i><span data-i18n="comp_mcq">Multiple Choice</span></div>
                  <div class="component-item field cursor-move" draggable="true" data-type="checkbox"><i class="fa-solid fa-square-check text-primary-400 mr-2"></i><span data-i18n="comp_check">Checkboxes</span></div>
                  <div class="component-item field cursor-move" draggable="true" data-type="dropdown"><i class="fa-solid fa-caret-down text-primary-400 mr-2"></i><span data-i18n="comp_drop">Dropdown</span></div>
                  <div class="component-item field cursor-move" draggable="true" data-type="rating"><i class="fa-solid fa-star text-primary-400 mr-2"></i><span data-i18n="comp_rate">Rating</span></div>
                  <div class="component-item field cursor-move" draggable="true" data-type="date"><i class="fa-solid fa-calendar-days text-primary-400 mr-2"></i><span data-i18n="comp_date">Date Picker</span></div>
                  <div class="component-item field cursor-move" draggable="true" data-type="scale"><i class="fa-solid fa-sliders text-primary-400 mr-2"></i><span data-i18n="comp_scale">Linear Scale</span></div>
                  <div class="component-item field cursor-move" draggable="true" data-type="file"><i class="fa-solid fa-file-arrow-up text-primary-400 mr-2"></i><span data-i18n="comp_file">File Upload</span></div>
                  <div class="component-item field cursor-move" draggable="true" data-type="section"><i class="fa-solid fa-bars text-primary-400 mr-2"></i><span data-i18n="comp_section">Section Header</span></div>
                </div>
              </div>

              <div class="card p-5">
                <div class="flex items-center justify-between mb-4">
                  <h3 class="font-medium" data-i18n="canvas">Canvas</h3>
                  <div class="flex items-center gap-2">
                    <input id="builder-title" class="field" placeholder="Survey title" />
                    <button class="btn btn-ghost" id="clear-canvas"><i class="fa-regular fa-trash-can"></i></button>
                  </div>
                </div>
                <div id="survey-canvas" class="min-h-[360px] bg-white/5 border border-white/10 rounded-lg p-4">
                  <div class="empty p-6 text-center text-ink-400" id="drop-here">
                    <i class="fa-solid fa-arrow-down text-2xl mb-2 text-primary-400"></i>
                    <p data-i18n="drop_to_build">Drag components here to build your survey</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- Route: Share -->
        <section id="route-share" class="route hidden">
          <div class="flex items-center justify-between mb-6">
            <div>
              <h1 class="text-xl font-semibold" data-i18n="share">Share</h1>
              <p class="text-ink-400 text-sm" data-i18n="share_sub">Distribute your surveys with advanced options</p>
            </div>
            <div class="flex items-center gap-3">
              <button class="btn btn-ghost" id="export-btn"><i class="fa-solid fa-download"></i> <span data-i18n="export">Export</span></button>
              <button class="btn btn-primary" id="generate-share-link"><i class="fa-solid fa-link"></i> <span data-i18n="gen_link">Generate Link</span></button>
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <div class="card p-5">
              <h3 class="font-medium mb-2" data-i18n="gov_sec">Government Security Options</h3>
              <div class="space-y-3 text-sm">
                <div class="flex items-center justify-between"><span data-i18n="e2ee">End-to-End Encryption (UI demo)</span><label class="toggle"><input type="checkbox" id="opt-e2ee"><span class="slider"></span></label></div>
                <div class="flex items-center justify-between"><span data-i18n="rbac">Role-Based Access Control</span><label class="toggle"><input type="checkbox" id="opt-rbac"><span class="slider"></span></label></div>
                <div class="flex items-center justify-between"><span data-i18n="sovereignty">Data Sovereignty</span><label class="toggle"><input type="checkbox" id="opt-ds"><span class="slider"></span></label></div>
                <div class="flex items-center justify-between"><span data-i18n="audit">Audit Logging</span><label class="toggle"><input type="checkbox" id="opt-audit"><span class="slider"></span></label></div>
              </div>
              <button class="btn btn-primary w-full mt-4" id="gov-mode"><i class="fa-solid fa-shield-halved"></i> <span data-i18n="enable_gov">Enable Government Mode</span></button>
            </div>

            <div class="card p-5">
              <h3 class="font-medium mb-3" data-i18n="share_via">Share via</h3>
              <div class="grid grid-cols-4 gap-3">
                <button class="btn btn-ghost flex flex-col items-center py-3"><i class="fa-brands fa-whatsapp text-green-400 text-xl mb-1"></i><span class="text-xs">WhatsApp</span></button>
                <button class="btn btn-ghost flex flex-col items-center py-3"><i class="fa-solid fa-envelope text-ink-300 text-xl mb-1"></i><span class="text-xs">Email</span></button>
                <button class="btn btn-ghost flex flex-col items-center py-3"><i class="fa-brands fa-telegram text-blue-300 text-xl mb-1"></i><span class="text-xs">Telegram</span></button>
                <button class="btn btn-ghost flex flex-col items-center py-3"><i class="fa-solid fa-qrcode text-ink-300 text-xl mb-1"></i><span class="text-xs">QR</span></button>
              </div>
              <div class="mt-4">
                <label class="block mb-2 text-sm" data-i18n="embed_code">Embed Code</label>
                <div class="flex gap-2"><input type="text" id="embed-code" class="field w-full" readonly /><button class="btn btn-ghost flex-shrink-0" id="copy-embed"><i class="fa-regular fa-copy"></i></button></div>
              </div>
            </div>
          </div>
        </section>

        <!-- Route: Analytics -->
        <section id="route-analytics" class="route hidden">
          <div class="flex items-center justify-between mb-6">
            <div>
              <h1 class="text-xl font-semibold" data-i18n="analytics">Analytics</h1>
              <p class="text-ink-400 text-sm" data-i18n="analytics_sub">Gain insights from your survey data</p>
            </div>
            <div class="flex items-center gap-3">
              <div class="relative">
                <i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-ink-400"></i>
                <input class="field pl-10 w-64" id="analytics-search" placeholder="Search analytics..." />
              </div>
              <button class="btn btn-primary" id="export-report"><i class="fa-solid fa-download"></i> <span data-i18n="export">Export</span></button>
            </div>
          </div>

          <div class="flex items-center gap-3 mb-4">
            <select id="analytics-survey" class="field"></select>
            <button id="simulate-responses" class="btn btn-ghost"><i class="fa-solid fa-vial"></i> Simulate Responses</button>
          </div>

          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <div class="card p-6">
              <h3 class="font-medium mb-4" data-i18n="resp_rate">Response Rate</h3>
              <div class="relative h-72"><canvas id="chart-response-rate"></canvas><div class="empty absolute inset-0 grid place-items-center text-ink-400 text-sm rounded-xl" id="empty-rr"><div class="text-center"><i class="fa-solid fa-chart-line text-3xl mb-3 opacity-50"></i><p data-i18n="no_resp">No response data available</p></div></div></div>
            </div>
            <div class="card p-6">
              <h3 class="font-medium mb-4" data-i18n="device_break">Completion by Device</h3>
              <div class="relative h-72"><canvas id="chart-device-breakdown"></canvas><div class="empty absolute inset-0 grid place-items-center text-ink-400 text-sm rounded-xl" id="empty-db"><div class="text-center"><i class="fa-solid fa-mobile-screen text-3xl mb-3 opacity-50"></i><p data-i18n="no_device">No device data available</p></div></div></div>
            </div>
          </div>

          <div class="card p-6">
            <h3 class="font-medium mb-4" data-i18n="detailed_resp">Detailed Responses</h3>
            <div class="overflow-x-auto">
              <table class="w-full border-collapse">
                <thead>
                  <tr class="text-left border-b border-white/10">
                    <th class="py-2">Survey</th>
                    <th class="py-2">Responses</th>
                    <th class="py-2">Completion</th>
                    <th class="py-2">Avg. Time</th>
                    <th class="py-2">Status</th>
                  </tr>
                </thead>
                <tbody id="responses-table">
                  <tr><td colspan="5" class="text-center py-8 text-ink-400"><i class="fa-solid fa-table text-3xl mb-3 opacity-50"></i><span data-i18n="no_resp">No response data available</span></td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- Route: Audience -->
        <section id="route-audience" class="route hidden">
          <div class="flex items-center justify-between mb-6">
            <div>
              <h1 class="text-xl font-semibold" data-i18n="audience">Audience</h1>
              <p class="text-ink-400 text-sm" data-i18n="audience_sub">Manage your survey participants</p>
            </div>
            <div class="flex items-center gap-3">
              <div class="relative"><i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-ink-400"></i><input class="field pl-10 w-64" id="audience-search" placeholder="Search audience..." /></div>
              <button class="btn btn-primary" id="add-contact"><i class="fa-solid fa-plus"></i> <span data-i18n="add_contact">Add Contact</span></button>
            </div>
          </div>
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
            <div class="card p-6">
              <h3 class="font-medium mb-4" data-i18n="aud_over">Audience Overview</h3>
              <div class="space-y-3">
                <div class="flex items-center justify-between"><span class="text-ink-400" data-i18n="total_contacts">Total Contacts</span><span class="font-semibold" id="kpi-contacts">0</span></div>
                <div class="flex items-center justify-between"><span class="text-ink-400" data-i18n="active">Active</span><span class="font-semibold" id="kpi-contacts-active">0</span></div>
                <div class="flex items-center justify-between"><span class="text-ink-400" data-i18n="unsub">Unsubscribed</span><span class="font-semibold" id="kpi-contacts-unsub">0</span></div>
                <div class="flex items-center justify-between"><span class="text-ink-400" data-i18n="groups">Groups</span><span class="font-semibold" id="kpi-contacts-groups">0</span></div>
              </div>
            </div>
            <div class="card p-6 lg:col-span-2">
              <h3 class="font-medium mb-4" data-i18n="contact_growth">Contact Growth</h3>
              <div class="relative h-64"><canvas id="chart-audience-growth"></canvas><div class="empty absolute inset-0 grid place-items-center text-ink-400 text-sm rounded-xl" id="empty-ag"><div class="text-center"><i class="fa-solid fa-user-group text-3xl mb-3 opacity-50"></i><p data-i18n="no_audience">No audience data available</p></div></div></div>
            </div>
          </div>
          <div class="card p-6">
            <h3 class="font-medium mb-4" data-i18n="contact_list">Contact List</h3>
            <div class="overflow-x-auto">
              <table class="w-full border-collapse">
                <thead>
                  <tr class="text-left border-b border-white/10">
                    <th class="py-2" data-i18n="name">Name</th>
                    <th class="py-2" data-i18n="email">Email</th>
                    <th class="py-2" data-i18n="group">Group</th>
                    <th class="py-2" data-i18n="status">Status</th>
                    <th class="py-2" data-i18n="last_activity">Last Activity</th>
                  </tr>
                </thead>
                <tbody id="audience-table">
                  <tr><td colspan="5" class="text-center py-8 text-ink-400"><i class="fa-solid fa-address-book text-3xl mb-3 opacity-50"></i><span data-i18n="no_contacts">No contacts yet</span></td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- Route: Settings -->
        <section id="route-settings" class="route hidden">
          <div class="flex items-center justify-between mb-6">
            <div>
              <h1 class="text-xl font-semibold" data-i18n="settings">Settings</h1>
              <p class="text-ink-400 text-sm" data-i18n="settings_sub">Configure your account and preferences</p>
            </div>
          </div>
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="card p-6">
              <h3 class="font-medium mb-4" data-i18n="account_settings">Account Settings</h3>
              <div class="space-y-4">
                <label class="block"><span class="block text-sm mb-1" data-i18n="fullname">Full Name</span><input type="text" class="field w-full" id="profile-name" value="" /></label>
                <label class="block"><span class="block text-sm mb-1" data-i18n="email">Email Address</span><input type="email" class="field w-full" id="profile-email" value="" /></label>
                <label class="block"><span class="block text-sm mb-1" data-i18n="timezone">Time Zone</span>
                  <select class="field w-full" id="profile-tz">
                    <option>Asia/Kolkata (IST)</option>
                    <option>UTC</option>
                    <option>America/Los_Angeles (PT)</option>
                    <option>Europe/London (BT)</option>
                  </select>
                </label>
                <button class="btn btn-primary w-full" id="save-profile" data-i18n="save">Save</button>
              </div>
            </div>
            <div class="card p-6">
              <h3 class="font-medium mb-4" data-i18n="ui_prefs">Interface Preferences</h3>
              <div class="space-y-4">
                <label class="flex items-center justify-between"><span class="text-sm" data-i18n="compact">Compact Mode</span><label class="toggle"><input type="checkbox" id="pref-compact"><span class="slider"></span></label></label>
                <label class="flex items-center justify-between"><span class="text-sm">Dark Mode</span><label class="toggle"><input type="checkbox" id="pref-dark" checked><span class="slider"></span></label></label>
                <label class="flex items-center justify-between"><span class="text-sm" data-i18n="email_notif">Email Notifications</span><label class="toggle"><input type="checkbox" id="pref-email" checked><span class="slider"></span></label></label>
              </div>
            </div>
            <div class="card p-6">
              <h3 class="font-medium mb-4"><i class="fa-solid fa-shield-halved text-success"></i> <span data-i18n="security_settings">Security Settings</span></h3>
              <div class="space-y-4 text-sm">
                <div class="flex items-center justify-between"><span data-i18n="twofa">Two-Factor Authentication</span><button class="btn btn-ghost" id="btn-2fa"><i class="fa-solid fa-shield-halved"></i> <span data-i18n="enable">Enable</span></button></div>
                <div class="flex items-center justify-between"><span data-i18n="gov_mode">Government Security Mode</span><button class="btn btn-primary" id="btn-gov2"><i class="fa-solid fa-building-shield"></i> <span data-i18n="enable">Enable</span></button></div>
              </div>
            </div>
          </div>
        </section>
      </main>
    </div>
  </section>

  <!-- Create Survey Modal -->
  <div id="create-survey-modal" class="fixed inset-0 bg-black/70 hidden items-center justify-center p-4 z-50">
    <div class="card w-full max-w-xl p-6">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-semibold" data-i18n="create_survey">Create Survey</h2>
        <button class="btn btn-ghost p-2" id="close-create"><i class="fa-solid fa-xmark"></i><span class="sr-only">Close</span></button>
      </div>
      <label class="block mb-4"><span class="block text-sm mb-1" data-i18n="survey_title">Survey Title</span><input type="text" id="survey-title" class="field w-full" placeholder="Customer Feedback Q4" /></label>
      <h3 class="font-medium mb-3" data-i18n="choose_method">Choose Creation Method</h3>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
        <button class="card p-5 text-left hover:border-primary-400" data-method="blank"><div class="w-12 h-12 rounded-full bg-primary-500/20 grid place-items-center mb-2"><i class="fa-solid fa-file text-primary-400"></i></div><div class="font-medium" data-i18n="start_scratch">Start from Scratch</div><div class="text-xs text-ink-400" data-i18n="scratch_sub">Create a custom survey</div></button>
        <button class="card p-5 text-left hover:border-primary-400" data-method="template"><div class="w-12 h-12 rounded-full bg-primary-500/20 grid place-items-center mb-2"><i class="fa-solid fa-grid-2 text-primary-400"></i></div><div class="font-medium" data-i18n="use_template">Use a Template</div><div class="text-xs text-ink-400" data-i18n="template_sub">Choose a professional template</div></button>
        <button class="card p-5 text-left hover:border-primary-400" data-method="ai"><div class="w-12 h-12 rounded-full bg-primary-500/20 grid place-items-center mb-2"><i class="fa-solid fa-wand-magic-sparkles text-primary-400"></i></div><div class="font-medium" data-i18n="ai_assistant">AI Assistant</div><div class="text-xs text-ink-400" data-i18n="ai_sub">Generate from topic</div></button>
        <button class="card p-5 text-left hover:border-primary-400" data-method="import"><div class="w-12 h-12 rounded-full bg-primary-500/20 grid place-items-center mb-2"><i class="fa-solid fa-file-import text-primary-400"></i></div><div class="font-medium" data-i18n="import_q">Import Questions</div><div class="text-xs text-ink-400" data-i18n="import_sub">CSV / Word</div></button>
      </div>
      <div class="flex justify-end gap-2"><button class="btn btn-ghost" id="cancel-create" data-i18n="cancel">Cancel</button><button class="btn btn-primary" id="confirm-create" disabled data-i18n="create">Create</button></div>
    </div>
  </div>

  <!-- Preview Modal -->
  <div id="preview-modal" class="fixed inset-0 bg-black/70 hidden items-center justify-center p-4 z-50">
    <div class="card w-full max-w-2xl p-6">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-semibold">Preview</h2>
        <button class="btn btn-ghost p-2" id="close-preview"><i class="fa-solid fa-xmark"></i><span class="sr-only">Close</span></button>
      </div>
      <div id="preview-content" class="space-y-4"></div>
      <div class="flex justify-end mt-6"><button class="btn btn-primary" id="start-preview-submit"><i class="fa-solid fa-paper-plane"></i> Submit (demo)</button></div>
    </div>
  </div>

  <script>
    // ------- i18n -------
    const I18N = {
      en: {
        auth_title:'Connect to SurveyCraft Pro', auth_sub:'Sign in to continue.', login:'Login', signup:'Sign Up', email:'Email', password:'Password', remember:'Remember me', forgot:'Forgot password?', signin:'Sign In', login_err:'Authentication failed. Check your credentials.', fullname:'Full name', agree:'I agree to the terms', create:'Create Account', signup_err:'Please verify your details.', connect:'Connect', dashboard:'Dashboard', surveys:'Surveys', builder:'Builder', share:'Share', analytics:'Analytics', audience:'Audience', settings:'Settings', logout:'Logout', kpi_surveys:'Surveys', kpi_responses:'Responses', kpi_completion:'Completion Rate', kpi_active:'Active Now', resp_time:'Responses Over Time', no_resp:'No response data available', survey_status:'Survey Status', no_survey:'No survey data available', surveys_sub:'Create and manage your surveys', new_survey:'New Survey', no_surveys:'No surveys yet', start_create:'Get started by creating your first survey', create_survey:'Create Survey', builder_sub:'Drag & drop components to create your survey', preview:'Preview', save:'Save', components:'Components', drag_here:'Drag components into the canvas', comp_text:'Text Question', comp_mcq:'Multiple Choice', comp_check:'Checkboxes', comp_drop:'Dropdown', comp_rate:'Rating', comp_date:'Date Picker', comp_scale:'Linear Scale', comp_file:'File Upload', comp_section:'Section Header', canvas:'Canvas', drop_to_build:'Drag components here to build your survey', share_sub:'Distribute your surveys with advanced options', export:'Export', gen_link:'Generate Link', gov_sec:'Government Security Options', e2ee:'End-to-End Encryption (UI demo)', rbac:'Role-Based Access Control', sovereignty:'Data Sovereignty', audit:'Audit Logging', enable_gov:'Enable Government Mode', share_via:'Share via', embed_code:'Embed Code', analytics_sub:'Gain insights from your survey data', resp_rate:'Response Rate', device_break:'Completion by Device', detailed_resp:'Detailed Responses', audience_sub:'Manage your survey participants', add_contact:'Add Contact', aud_over:'Audience Overview', total_contacts:'Total Contacts', active:'Active', unsub:'Unsubscribed', groups:'Groups', contact_growth:'Contact Growth', contact_list:'Contact List', name:'Name', status:'Status', last_activity:'Last Activity', no_contacts:'No contacts yet', settings_sub:'Configure your account and preferences', account_settings:'Account Settings', timezone:'Time Zone', save_profile:'Save', ui_prefs:'Interface Preferences', email_notif:'Email Notifications', compact:'Compact Mode', security_settings:'Security Settings', twofa:'Two-Factor Authentication', enable:'Enable', gov_mode:'Government Security Mode', survey_title:'Survey Title', choose_method:'Choose Creation Method', start_scratch:'Start from Scratch', scratch_sub:'Create a custom survey', use_template:'Use a Template', template_sub:'Choose a professional template', ai_assistant:'AI Assistant', ai_sub:'Generate from topic', import_q:'Import Questions', import_sub:'CSV / Word', cancel:'Cancel', create:'Create'
      },
      hi: { auth_title:'SurveyCraft Pro से कनेक्ट करें', auth_sub:'जारी रखने के लिए साइन इन करें।', login:'लॉगिन', signup:'साइन अप', email:'ईमेल', password:'पासवर्ड', remember:'मुझे याद रखें', forgot:'पासवर्ड भूल गए?', signin:'साइन इन', login_err:'कृपया अपनी जानकारी जाँचें।', fullname:'पूरा नाम', agree:'मैं नियमों से सहमत हूँ', create:'खाता बनाएं', signup_err:'कृपया विवरण सत्यापित करें।', connect:'कनेक्ट', dashboard:'डैशबोर्ड', surveys:'सर्वे', builder:'बिल्डर', share:'शेयर', analytics:'एनालिटिक्स', audience:'ऑडियंस', settings:'सेटिंग्स', logout:'लॉगआउट', kpi_surveys:'सर्वे', kpi_responses:'रेस्पॉन्स', kpi_completion:'कम्प्लीशन रेट', kpi_active:'अभी सक्रिय', resp_time:'समय के साथ रेस्पॉन्स', no_resp:'डेटा उपलब्ध नहीं', survey_status:'सर्वे स्थिति', no_survey:'सर्वे डेटा उपलब्ध नहीं', surveys_sub:'अपने सर्वे बनाएं और मैनेज करें', new_survey:'नया सर्वे', no_surveys:'अभी कोई सर्वे नहीं', start_create:'पहला सर्वे बनाकर शुरू करें', create_survey:'सर्वे बनाएं', builder_sub:'कंपोनेंट ड्रैग & ड्रॉप करें', preview:'पूर्वावलोकन', save:'सेव', components:'कंपोनेंट्स', drag_here:'कंपोनेंट यहाँ ड्रैग करें', comp_text:'टेक्स्ट प्रश्न', comp_mcq:'बहुविकल्पी', comp_check:'चेकबॉक्स', comp_drop:'ड्रॉपडाउन', comp_rate:'रेटिंग', comp_date:'तारीख चयन', comp_scale:'लिनीयर स्केल', comp_file:'फ़ाइल अपलोड', comp_section:'सेक्शन हेडर', canvas:'कैनवास', drop_to_build:'यहाँ ड्रैग करके सर्वे बनाएं', share_sub:'एडवांस्ड विकल्पों के साथ साझा करें', export:'एक्सपोर्ट', gen_link:'लिंक बनाएं', gov_sec:'सरकारी सुरक्षा विकल्प', e2ee:'एंड-टू-एंड एन्क्रिप्शन (UI)', rbac:'भूमिका-आधारित एक्सेस', sovereignty:'डेटा संप्रभुता', audit:'ऑडिट लॉगिंग', enable_gov:'गवर्नमेंट मोड सक्षम करें', share_via:'इसके माध्यम से साझा करें', embed_code:'एम्बेड कोड', analytics_sub:'अपने डेटा से इनसाइट्स प्राप्त करें', resp_rate:'रेस्पॉन्स रेट', device_break:'डिवाइस के अनुसार कम्प्लीशन', detailed_resp:'विस्तृत प्रतिक्रियाएँ', audience_sub:'प्रतिभागियों का प्रबंधन', add_contact:'संपर्क जोड़ें', aud_over:'ऑडियंस ओवरव्यू', total_contacts:'कुल संपर्क', active:'सक्रिय', unsub:'अनसब्सक्राइब्ड', groups:'समूह', contact_growth:'कॉन्टैक्ट ग्रोथ', contact_list:'कॉन्टैक्ट सूची', name:'नाम', status:'स्थिति', last_activity:'अंतिम गतिविधि', no_contacts:'अभी कोई संपर्क नहीं', settings_sub:'खाता वरीयताएँ सेट करें', account_settings:'खाता सेटिंग्स', timezone:'समय क्षेत्र', save_profile:'सेव', ui_prefs:'इंटरफ़ेस प्रेफ़रेंसेज़', email_notif:'ईमेल सूचनाएँ', compact:'कॉम्पैक्ट मोड', security_settings:'सुरक्षा सेटिंग्स', twofa:'द्वि-कारक प्रमाणीकरण', enable:'सक्षम करें', gov_mode:'गवर्नमेंट मोड', survey_title:'सर्वे शीर्षक', choose_method:'बनाने की विधि चुनें', start_scratch:'शुरू से बनाएँ', scratch_sub:'कस्टम सर्वे बनाएँ', use_template:'टेम्पलेट उपयोग करें', template_sub:'प्रोफेशनल टेम्पलेट चुनें', ai_assistant:'AI सहायक', ai_sub:'विषय से जनरेट करें', import_q:'प्रश्न आयात करें', import_sub:'CSV / Word', cancel:'रद्द', create:'बनाएँ' },
      es:{auth_title:'Conectar a SurveyCraft Pro',auth_sub:'Inicia sesión para continuar.',login:'Iniciar sesión',signup:'Registrarse',email:'Correo',password:'Contraseña',remember:'Recuérdame',forgot:'¿Olvidaste la contraseña?',signin:'Entrar',login_err:'Fallo de autenticación.',fullname:'Nombre completo',agree:'Acepto los términos',create:'Crear cuenta',signup_err:'Verifica tus datos.',connect:'Conectar',dashboard:'Panel',surveys:'Encuestas',builder:'Constructor',share:'Compartir',analytics:'Analítica',audience:'Audiencia',settings:'Ajustes',logout:'Salir',kpi_surveys:'Encuestas',kpi_responses:'Respuestas',kpi_completion:'Tasa de finalización',kpi_active:'Activos ahora',resp_time:'Respuestas en el tiempo',no_resp:'Sin datos',survey_status:'Estado de encuestas',no_survey:'Sin datos de encuestas',surveys_sub:'Crea y gestiona encuestas',new_survey:'Nueva encuesta',no_surveys:'Aún no hay encuestas',start_create:'Crea tu primera encuesta',create_survey:'Crear encuesta',builder_sub:'Arrastra y suelta componentes',preview:'Vista previa',save:'Guardar',components:'Componentes',drag_here:'Arrastra aquí',comp_text:'Pregunta de texto',comp_mcq:'Opción múltiple',comp_check:'Casillas',comp_drop:'Desplegable',comp_rate:'Valoración',comp_date:'Fecha',comp_scale:'Escala lineal',comp_file:'Subir archivo',comp_section:'Encabezado',canvas:'Lienzo',drop_to_build:'Arrastra para construir',share_sub:'Comparte con opciones avanzadas',export:'Exportar',gen_link:'Generar enlace',gov_sec:'Opciones de seguridad gubernamental',e2ee:'Cifrado extremo a extremo',rbac:'Control de acceso por rol',sovereignty:'Soberanía de datos',audit:'Registro de auditoría',enable_gov:'Activar modo gobierno',share_via:'Compartir vía',embed_code:'Código de inserción',analytics_sub:'Obtén información',resp_rate:'Tasa de respuesta',device_break:'Finalización por dispositivo',detailed_resp:'Respuestas detalladas',audience_sub:'Gestiona participantes',add_contact:'Agregar contacto',aud_over:'Resumen de audiencia',total_contacts:'Contactos totales',active:'Activos',unsub:'Darse de baja',groups:'Grupos',contact_growth:'Crecimiento de contactos',contact_list:'Lista de contactos',name:'Nombre',status:'Estado',last_activity:'Última actividad',no_contacts:'Sin contactos',settings_sub:'Configura tu cuenta',account_settings:'Ajustes de cuenta',timezone:'Zona horaria',save_profile:'Guardar',ui_prefs:'Preferencias de interfaz',email_notif:'Notificaciones por correo',compact:'Modo compacto',security_settings:'Ajustes de seguridad',twofa:'Autenticación de dos factores',enable:'Activar',gov_mode:'Modo gobierno',survey_title:'Título',choose_method:'Elige método',start_scratch:'Desde cero',scratch_sub:'Crea una encuesta',use_template:'Usar plantilla',template_sub:'Elige una plantilla',ai_assistant:'Asistente IA',ai_sub:'Generar por tema',import_q:'Importar preguntas',import_sub:'CSV / Word',cancel:'Cancelar',create:'Crear'},
      fr:{auth_title:"Se connecter à SurveyCraft Pro",auth_sub:"Connectez‑vous pour continuer.",login:"Connexion",signup:"Inscription",email:"Email",password:"Mot de passe",remember:"Se souvenir de moi",forgot:"Mot de passe oublié ?",signin:"Se connecter",login_err:"Échec d'authentification.",fullname:"Nom complet",agree:"J'accepte les conditions",create:"Créer un compte",signup_err:"Vérifiez vos informations.",connect:"Connexion",dashboard:"Tableau de bord",surveys:"Sondages",builder:"Éditeur",share:"Partager",analytics:"Analytique",audience:"Audience",settings:"Paramètres",logout:"Déconnexion",kpi_surveys:"Sondages",kpi_responses:"Réponses",kpi_completion:"Taux d'achèvement",kpi_active:"Actifs",resp_time:"Réponses au fil du temps",no_resp:"Aucune donnée",survey_status:"Statut des sondages",no_survey:"Aucune donnée de sondage",surveys_sub:"Créez et gérez vos sondages",new_survey:"Nouveau sondage",no_surveys:"Pas encore de sondage",start_create:"Créez votre premier sondage",create_survey:"Créer un sondage",builder_sub:"Glisser‑déposer des composants",preview:"Aperçu",save:"Enregistrer",components:"Composants",drag_here:"Glissez ici",comp_text:"Question texte",comp_mcq:"Choix multiple",comp_check:"Cases à cocher",comp_drop:"Liste déroulante",comp_rate:"Évaluation",comp_date:"Date",comp_scale:"Échelle linéaire',comp_file:"Téléverser un fichier",comp_section:"En‑tête",canvas:"Canvas",drop_to_build:"Glissez pour créer",share_sub:"Partage avancé",export:"Exporter",gen_link:"Générer le lien",gov_sec:"Opciones de seguridad gubernamental",e2ee:"Chiffrement de bout en bout",rbac:"Contrôle d'accès par rôle",sovereignty:"Souveraineté des données",audit:"Journal d'audit",enable_gov:"Activer le mode gouvernement",share_via:"Partager via",embed_code:"Code d'intégration",analytics_sub:"Obtenez des insights",resp_rate:"Taux de réponse",device_break:"Achèvement par appareil",detailed_resp:"Réponses détaillées",audience_sub:"Gérez vos participants",add_contact:"Ajouter un contact",aud_over:"Vue d'ensemble",total_contacts:"Contacts totaux",active:"Actifs",unsub:"Désabonnés",groups:"Groupes",contact_growth:"Croissance des contacts",contact_list:"Liste de contacts",name:"Nom",status:"Statut",last_activity:"Dernière activité",no_contacts:"Aucun contact",settings_sub:"Configurez votre compte",account_settings:"Paramètres du compte",timezone:"Fuseau horaire",save_profile:"Enregistrer",ui_prefs:"Préférences d'interface",email_notif:"Notifications email",compact:"Mode compact",security_settings:"Paramètres de seguridad",twofa:"Authentification à deux facteurs",enable:"Activer",gov_mode:"Mode gouvernement",survey_title:"Titre du sondage",choose_method:"Choisir la méthode",start_scratch:"Partir de zéro",scratch_sub:"Créer un sondage personnalisé",use_template:"Utiliser un modèle",template_sub:"Choisir un modèle",ai_assistant:"Assistant IA",ai_sub:"Générer depuis un sujet",import_q:"Importer des questions",import_sub:"CSV / Word",cancel:"Annuler",create:"Créer"},
      de:{auth_title:'Mit SurveyCraft Pro verbinden',auth_sub:'Zum Fortfahren anmelden.',login:'Anmelden',signup:'Registrieren',email:'E‑Mail',password:'Passwort',remember:'Angemeldet bleiben',forgot:'Passwort vergessen?',signin:'Einloggen',login_err:'Authentifizierung fehlgeschlagen.',fullname:'Vollständiger Name',agree:'Ich stimme den Bedingungen zu',create:'Konto erstellen',signup_err:'Bitte Details prüfen.',connect:'Verbinden',dashboard:'Dashboard',surveys:'Umfragen',builder:'Builder',share:'Teilen',analytics:'Analytik',audience:'Zielgruppe',settings:'Einstellungen',logout:'Abmelden',kpi_surveys:'Umfragen',kpi_responses:'Antworten',kpi_completion:'Abschlussrate',kpi_active:'Aktiv jetzt',resp_time:'Antworten im Zeitverlauf',no_resp:'Keine Daten',survey_status:'Umfragestatus',no_survey:'Keine Umfragedaten',surveys_sub:'Umfragen erstellen und verwalten',new_survey:'Neue Umfrage',no_surveys:'Noch keine Umfragen',start_create:'Erste Umfrage erstellen',create_survey:'Umfrage erstellen',builder_sub:'Per Drag & Drop erstellen',preview:'Vorschau',save:'Speichern',components:'Komponenten',drag_here:'Hierher ziehen',comp_text:'Textfrage',comp_mcq:'Multiple Choice',comp_check:'Kontrollkästchen',comp_drop:'Dropdown',comp_rate:'Bewertung',comp_date:'Datum',comp_scale:'Lineare Skala',comp_file:'Datei hochladen',comp_section:'Abschnittsüberschrift',canvas:'Arbeitsfläche',drop_to_build:'Zum Erstellen hierher ziehen',share_sub:'Mit erweiterten Optionen teilen',export:'Exportieren',gen_link:'Link erstellen',gov_sec:'Behördliche Sicherheitsoptionen',e2ee:'Ende‑zu‑Ende‑Verschlüsselung',rbac:'Rollenbasierte Zugriffe',sovereignty:'Datenhoheit',audit:'Audit‑Protokoll',enable_gov:'Behördenmodus aktivieren',share_via:'Teilen über',embed_code:'Einbettungscode',analytics_sub:'Erkenntnisse gewinnen',resp_rate:'Antwortrate',device_break:'Abschluss nach Gerät',detailed_resp:'Detaillierte Antworten',audience_sub:'Teilnehmer verwalten',add_contact:'Kontakt hinzufügen',aud_over:'Übersicht',total_contacts:'Gesamtkontakte',active:'Aktiv',unsub:'Abgemeldet',groups:'Gruppen',contact_growth:'Kontaktwachstum',contact_list:'Kontaktliste',name:'Name',status:'Status',last_activity:'Letzte Aktivität',no_contacts:'Keine Kontakte',settings_sub:'Konto konfigurieren',account_settings:'Kontoeinstellungen',timezone:'Zeitzone',save_profile:'Änderungen speichern',ui_prefs:'Oberflächenpräferenzen',email_notif:'E‑Mail‑Benachrichtigungen',compact:'Kompaktmodus',security_settings:'Sicherheitseinstellungen',twofa:'Zwei‑Faktor‑Authentifizierung',enable:'Aktivieren',gov_mode:'Behördenmodus',survey_title:'Umfragetitel',choose_method:'Methode wählen',start_scratch:'Von Grund auf',scratch_sub:'Eigene Umfrage erstellen',use_template:'Vorlage verwenden',template_sub:'Professionelle Vorlage',ai_assistant:'KI‑Assistent',ai_sub:'Aus Thema generieren',import_q:'Fragen importieren',import_sub:'CSV / Word',cancel:'Abbrechen',create:'Erstellen'}
    };

    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

    // Toast notification
    function showToast(message, duration = 2500) {
      const toast = $('#toast');
      toast.textContent = message;
      toast.classList.remove('hidden');
      requestAnimationFrame(()=> toast.classList.add('show'));
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.classList.add('hidden'), 300);
      }, duration);
    }

    // Helpers
    const uid = (p='id') => p + '_' + Math.random().toString(36).slice(2,9) + Date.now().toString(36);
    const todayISO = () => new Date().toISOString();
    const currentLang = () => localStorage.getItem('scp_lang') || 'en';
    const setLang = (l) => localStorage.setItem('scp_lang', l);

    // Persist & switch language
    function applyI18n(lang){
      const dict = I18N[lang] || I18N.en;
      $$('[data-i18n]').forEach(el=>{ const t = dict[el.dataset.i18n]; if(t) el.textContent = t; });
      $('#current-lang').textContent = {en:'English',hi:'हिन्दी',es:'Español',fr:'Français',de:'Deutsch'}[lang] || 'English';
      document.documentElement.lang = lang;
    }

    // Tab switch
    $('#tab-login').addEventListener('click',()=>{
      $('#form-login').classList.remove('hidden');
      $('#form-signup').classList.add('hidden');
      $('#tab-login').dataset.active=true; $('#tab-signup').dataset.active=false;
      $('#signup-error').classList.add('hidden');
    });
    $('#tab-signup').addEventListener('click',()=>{
      $('#form-login').classList.add('hidden');
      $('#form-signup').classList.remove('hidden');
      $('#tab-login').dataset.active=false; $('#tab-signup').dataset.active=true;
      $('#login-error').classList.add('hidden');
    });

    // Routing
    const routes = ['dashboard','surveys','builder','share','analytics','audience','settings'];
    const routeDescriptions = {
      dashboard: 'Bring your data — we keep the UI clean.',
      surveys: 'Create and manage your surveys',
      builder: 'Drag & drop components to create your survey',
      share: 'Distribute your surveys with advanced options',
      analytics: 'Gain insights from your survey data',
      audience: 'Manage your survey participants',
      settings: 'Configure your account and preferences'
    };

    function routeTo(name){
      routes.forEach(r=>{
        const sec = document.getElementById('route-'+r);
        if(!sec) return;
        if(r===name){ sec.classList.remove('hidden'); $(`[data-route="${r}"]`)?.classList.add('active'); sec.classList.add('route'); }
        else { sec.classList.add('hidden'); $(`[data-route="${r}"]`)?.classList.remove('active'); }
      });
      $('#route-title').textContent = (I18N[currentLang()] && I18N[currentLang()][name]) || name.charAt(0).toUpperCase()+name.slice(1);
      $('#route-description').textContent = routeDescriptions[name] || '';
    }
    $$('[data-route]').forEach(a=>a.addEventListener('click', e=>{ e.preventDefault(); routeTo(a.dataset.route); }));

    // Language UI
    $('#lang-toggle').addEventListener('click',()=>{ const wasHidden = $('#lang-menu').classList.toggle('hidden'); $('#lang-toggle').setAttribute('aria-expanded', String(!wasHidden)); });
    $$('.language-option').forEach(btn=> btn.addEventListener('click',()=>{ setLang(btn.dataset.lang); applyI18n(btn.dataset.lang); $('#lang-menu').classList.add('hidden'); refreshAll(); }));

    // Builder logic
    const canvas = $('#survey-canvas');
    const dropHere = $('#drop-here');
    let editingSurveyId = null;

    function emptyCanvas(){ canvas.innerHTML = ''; canvas.appendChild(dropHere); dropHere.classList.remove('hidden'); editingSurveyId = null; $('#builder-title').value=''; }

    function addRipple(e){
      const btn = e.currentTarget;
      const circle = document.createElement('span');
      const d = Math.max(btn.clientWidth, btn.clientHeight);
      circle.style.width = circle.style.height = d + 'px';
      const rect = btn.getBoundingClientRect();
      circle.style.left = (e.clientX - rect.left - d/2) + 'px';
      circle.style.top = (e.clientY - rect.top - d/2) + 'px';
      circle.classList.add('ripple'); btn.appendChild(circle);
      setTimeout(()=> circle.remove(), 600);
    }
    $$('button').forEach(b=> b.addEventListener('click', addRipple));

    function componentCard(type){
      const qid = uid('q');
      const wrap = document.createElement('div');
      wrap.className = 'bg-white/5 border border-white/10 rounded-lg p-4 mb-3 animate-fadeup';
      wrap.dataset.qid = qid; wrap.dataset.type = type;
      wrap.innerHTML = `
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-2">
            <i class="fa-solid ${iconFor(type)} text-primary-400"></i>
            <input class="field" placeholder="${labelFor(type)}" />
          </div>
          <div class="flex items-center gap-2">
            <label class="text-xs flex items-center gap-2"><input type="checkbox" class="req"> <span>Required</span></label>
            <button class="btn btn-ghost px-2 drag-handle" title="Drag"><i class="fa-solid fa-grip-lines"></i></button>
            <button class="btn btn-ghost px-2 delete-q" title="Delete"><i class="fa-regular fa-trash-can"></i></button>
          </div>
        </div>
        <div class="mt-3 space-y-2 settings"></div>
      `;
      const settings = $('.settings', wrap);
      if(['multiple','checkbox','dropdown'].includes(type)){
        settings.appendChild(optionsEditor());
      } else if(type==='rating'){
        settings.innerHTML = `<label class="text-xs flex items-center gap-2">Max Stars <input type="number" class="field w-24 max" value="5" min="3" max="10"></label>`
      } else if(type==='scale'){
        settings.innerHTML = `<div class="flex gap-2 text-xs"><label class="flex items-center gap-2">Min <input type="number" class="field w-20 min" value="0"></label><label class="flex items-center gap-2">Max <input type="number" class="field w-20 max" value="10"></label></div>`
      } else if(type==='file'){
        settings.innerHTML = `<label class="text-xs flex items-center gap-2">Accept <input type="text" class="field" placeholder=".pdf,.png,.jpg"></label>`
      } else if(type==='section'){
        settings.innerHTML = `<p class="text-xs text-ink-400">Section header (no input)</p>`
      }
      wrap.querySelector('.delete-q').addEventListener('click',()=>{ wrap.remove(); checkEmptyCanvas(); });
      return wrap;
    }

    function optionsEditor(){
      const d = document.createElement('div');
      d.innerHTML = `
        <div class="space-y-2">
          <div class="flex gap-2 items-center option-row"><input class="field flex-1" placeholder="Option"/><button class="btn btn-ghost px-2 del-opt"><i class="fa-regular fa-trash-can"></i></button></div>
          <button class="btn btn-ghost add-opt"><i class="fa-solid fa-plus"></i> Add option</button>
        </div>`;
      d.querySelector('.add-opt').addEventListener('click',()=>{
        const row = document.createElement('div'); row.className='flex gap-2 items-center option-row';
        row.innerHTML = `<input class="field flex-1" placeholder="Option"/><button class="btn btn-ghost px-2 del-opt"><i class="fa-regular fa-trash-can"></i></button>`;
        d.querySelector('.add-opt').before(row);
        row.querySelector('.del-opt').addEventListener('click',()=> row.remove());
      });
      d.querySelector('.del-opt').addEventListener('click', e=> e.currentTarget.closest('.option-row').remove());
      return d;
    }

    function iconFor(t){ return ({text:'fa-font', multiple:'fa-list-ol', checkbox:'fa-square-check', dropdown:'fa-caret-down', rating:'fa-star', date:'fa-calendar-days', scale:'fa-sliders', file:'fa-file-arrow-up', section:'fa-bars'})[t] || 'fa-circle'; }
    function labelFor(t){ return ({text:'Short answer', multiple:'Multiple choice', checkbox:'Checkboxes', dropdown:'Dropdown', rating:'Rating', date:'Pick a date', scale:'Linear scale', file:'Upload a file', section:'Section title'})[t] || 'Question'; }

    function draggableSetup(){
      $$('.component-item').forEach(el=>{
        el.addEventListener('dragstart', e=>{ e.dataTransfer.setData('text/plain', e.currentTarget.dataset.type); });
      });
      canvas.addEventListener('dragover', e=>{ e.preventDefault(); canvas.classList.add('ring-2','ring-primary-400'); });
      canvas.addEventListener('dragleave', ()=> canvas.classList.remove('ring-2','ring-primary-400'));
      canvas.addEventListener('drop', e=>{
        e.preventDefault(); canvas.classList.remove('ring-2','ring-primary-400');
        dropHere.classList.add('hidden');
        const t = e.dataTransfer.getData('text/plain');
        canvas.appendChild(componentCard(t));
      });
      // Simple reordering via drag-handle + HTML5 dnd
      let dragEl=null;
      canvas.addEventListener('dragstart', e=>{
        if(e.target.closest('.drag-handle')){ dragEl = e.target.closest('[data-qid]'); e.dataTransfer.setData('text/plain', dragEl.dataset.qid); }
      });
      canvas.addEventListener('dragover', e=>{
        e.preventDefault(); const after = getDragAfterElement(canvas, e.clientY); const id = e.dataTransfer.getData('text/plain'); const el = canvas.querySelector(`[data-qid="${id}"]`);
        if(!el) return; if(after==null) canvas.appendChild(el); else canvas.insertBefore(el, after);
      });
    }
    function getDragAfterElement(container, y){
      const els = [...container.querySelectorAll('[data-qid]')];
      return els.reduce((closest, child)=>{
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height/2;
        if(offset < 0 && offset > closest.offset){ return { offset, element: child }; } else { return closest; }
      }, { offset: Number.NEGATIVE_INFINITY }).element;
    }

    function checkEmptyCanvas(){ if(canvas.querySelector('[data-qid]')) dropHere.classList.add('hidden'); else dropHere.classList.remove('hidden'); }

    $('#clear-canvas').addEventListener('click',()=>{ emptyCanvas(); showToast('Canvas cleared'); });

    // Save survey
    $('#save-survey').addEventListener('click',()=>{
      const title = $('#builder-title').value.trim();
      const blocks = [...canvas.querySelectorAll('[data-qid]')];
      if(!title){ showToast('Please set a survey title'); return; }
      if(blocks.length===0){ showToast('Add at least one question'); return; }
      const questions = blocks.map(b=>{
        const type = b.dataset.type; const label = b.querySelector('input.field').value || labelFor(type);
        const req = b.querySelector('.req').checked;
        const q = { id:b.dataset.qid, type, label, required:req };
        if(['multiple','checkbox','dropdown'].includes(type)){
          q.options = [...b.querySelectorAll('.option-row input')].map(i=>i.value).filter(Boolean);
        } else if(type==='rating'){
          q.max = parseInt(b.querySelector('input.max').value||5,10);
        } else if(type==='scale'){
          q.min = parseInt(b.querySelector('input.min').value||0,10);
          q.max = parseInt(b.querySelector('input.max').value||10,10);
        } else if(type==='file'){
          q.accept = b.querySelector('input[type=text]').value || '';
        }
        return q;
      });
      
      // Send to server via API
      fetch('/api/surveys', {
        method: editingSurveyId ? 'PUT' : 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          id: editingSurveyId,
          title,
          questions
        })
      })
      .then(response => response.json())
      .then(data => {
        if(data.success) {
          showToast('Survey saved');
          renderSurveys(); 
          routeTo('surveys');
        } else {
          showToast('Error saving survey: ' + data.message);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        showToast('Error saving survey');
      });
    });

    // Preview
    $('#btn-preview').addEventListener('click',()=>{
      const blocks = [...canvas.querySelectorAll('[data-qid]')];
      const wrap = $('#preview-content'); wrap.innerHTML='';
      if(blocks.length===0){ wrap.innerHTML = '<div class="text-ink-400">No questions added</div>'; }
      blocks.forEach(b=>{
        const type = b.dataset.type; const label = b.querySelector('input.field').value || labelFor(type);
        const row = document.createElement('div'); row.className='space-y-1';
        row.innerHTML = `<div class="font-medium">${label}${b.querySelector('.req').checked?' <span class=\'text-danger\'>*</span>':''}</div>`;
        let inputHTML='';
        if(type==='text') inputHTML = '<input class="field w-full" placeholder="Your answer" />';
        if(type==='multiple') inputHTML = b.querySelectorAll('.option-row input').length? [...b.querySelectorAll('.option-row input')].map((o,i)=>`<label class='flex items-center gap-2'><input type='radio' name='${b.dataset.qid}'/> ${o.value||('Option '+(i+1))}</label>`).join('') : '<div class="text-xs text-ink-400">No options</div>';
        if(type==='checkbox') inputHTML = b.querySelectorAll('.option-row input').length? [...b.querySelectorAll('.option-row input')].map((o,i)=>`<label class='flex items-center gap-2'><input type='checkbox'/> ${o.value||('Option '+(i+1))}</label>`).join('') : '<div class="text-xs text-ink-400">No options</div>';
        if(type==='dropdown') inputHTML = `<select class='field w-full'>${[...b.querySelectorAll('.option-row input')].map((o,i)=>`<option>${o.value||('Option '+(i+1))}</option>`).join('')}</select>`;
        if(type==='rating') inputHTML = '<div class="flex gap-1">' + Array.from({length: parseInt(b.querySelector('input.max').value||5,10)}).map(()=>'<i class="fa-regular fa-star"></i>').join('') + '</div>';
        if(type==='date') inputHTML = '<input type="date" class="field" />';
        if(type==='scale') inputHTML = `<input type='range' class='w-full' min='${b.querySelector('input.min').value||0}' max='${b.querySelector('input.max').value||10}' />`;
        if(type==='file') inputHTML = `<input type='file' class='field w-full' ${b.querySelector('input[type=text]').value?`accept='${b.querySelector('input[type=text]').value}'`:''} />`;
        if(type==='section') inputHTML = '<div class="text-ink-400 text-sm">(Section)</div>';
        row.insertAdjacentHTML('beforeend', `<div class='mt-1'>${inputHTML}</div>`);
        wrap.appendChild(row);
      });
      $('#preview-modal').classList.remove('hidden'); $('#preview-modal').classList.add('flex');
    });
    $('#close-preview').addEventListener('click',()=>{ $('#preview-modal').classList.add('hidden'); $('#preview-modal').classList.remove('flex'); });
    $('#start-preview-submit').addEventListener('click',()=>{ showToast('Submitted! (demo)'); $('#preview-modal').classList.add('hidden'); $('#preview-modal').classList.remove('flex'); });

    // Create modal
    const createModal = $('#create-survey-modal');
    function openCreate(){ createModal.classList.remove('hidden'); createModal.classList.add('flex'); $('#confirm-create').disabled = !$('#survey-title').value.trim(); }
    function closeCreate(){ createModal.classList.add('hidden'); createModal.classList.remove('flex'); }

    $('#btn-open-create')?.addEventListener('click', openCreate);
    $('#cta-create')?.addEventListener('click', openCreate);
    $('#close-create').addEventListener('click', closeCreate);
    $('#cancel-create').addEventListener('click', closeCreate);
    $('#survey-title').addEventListener('input',()=> $('#confirm-create').disabled = !$('#survey-title').value.trim());

    let chosenMethod = 'blank';
    $$('[data-method]').forEach(card=> card.addEventListener('click',()=>{
      $$('[data-method]').forEach(c=>c.classList.remove('ring-2','ring-primary-400'));
      card.classList.add('ring-2','ring-primary-400');
      chosenMethod = card.dataset.method;
    }));

    $('#confirm-create').addEventListener('click',()=>{
      const title = $('#survey-title').value.trim(); if(!title) return;
      closeCreate(); routeTo('builder'); emptyCanvas(); $('#builder-title').value = title;
      editingSurveyId = null;
      if(chosenMethod==='template'){
        // Simple customer feedback template
        canvas.appendChild(componentCard('rating'));
        canvas.appendChild(componentCard('multiple'));
        canvas.appendChild(componentCard('text'));
        showToast('Template loaded');
      } else if(chosenMethod==='ai'){
        const topic = prompt('Enter a topic for AI to generate questions (offline demo)');
        if(topic){
          const t = componentCard('text'); t.querySelector('input.field').value = `What do you think about ${topic}?`;
          const m = componentCard('multiple'); m.querySelectorAll('.option-row input')[0].value = 'Excellent'; m.querySelector('.add-opt').click(); m.querySelectorAll('.option-row input')[1].value = 'Good'; m.querySelector('.add-opt').click(); m.querySelectorAll('.option-row input')[2].value = 'Average'; m.querySelector('.add-opt').click(); m.querySelectorAll('.option-row input')[3].value = 'Poor';
          canvas.appendChild(t); canvas.appendChild(m);
          showToast('AI-generated draft added');
        }
      } else if(chosenMethod==='import'){
        const csv = prompt('Paste CSV lines: Question,Type (text|multiple|checkbox|dropdown|rating|date|scale|file|section)');
        if(csv){ csv.split(/\n+/).forEach(line=>{ const [q, t] = line.split(',').map(s=> (s||'').trim()); if(t){ const c = componentCard(t); c.querySelector('input.field').value = q || labelFor(t); canvas.appendChild(c); } }); showToast('Imported'); }
      }
    });

    // Share / Export
    $('#generate-share-link').addEventListener('click',()=>{
      fetch('/api/surveys')
        .then(response => response.json())
        .then(surveys => {
          if(surveys.length===0){ showToast('No surveys to share'); return; }
          const s = surveys[0]; // demo: first survey
          const link = `${window.location.origin}/survey/${s.id}`;
          $('#embed-code').value = `<iframe src="${link}" width="100%" height="500"></iframe>`;
          navigator.clipboard.writeText(link).catch(()=>{});
          showToast('Share link copied');
        });
    });
    $('#copy-embed').addEventListener('click',()=>{ navigator.clipboard.writeText($('#embed-code').value).then(()=> showToast('Embed code copied')); });

    $('#export-btn').addEventListener('click',()=>{
      fetch('/api/export')
        .then(response => response.json())
        .then(data => {
          const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
          const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `surveycraft_export_${Date.now()}.json`; a.click(); URL.revokeObjectURL(a.href); showToast('Exported JSON');
        });
    });

    // GOV Mode
    function setGovMode(on){ localStorage.setItem('scp_gov', JSON.stringify(!!on)); $('#gov-badge').classList.toggle('hidden', !on); document.body.classList.toggle('ring-4', on); document.body.classList.toggle('ring-warning/40', on); }
    $('#gov-mode').addEventListener('click',()=>{ const on = !JSON.parse(localStorage.getItem('scp_gov')||'false'); setGovMode(on); showToast(on? 'Government Mode enabled (UI only)':'Government Mode disabled'); });
    $('#btn-gov2').addEventListener('click',()=>{ const on = !JSON.parse(localStorage.getItem('scp_gov')||'false'); setGovMode(on); showToast(on? 'Government Mode enabled (UI only)':'Government Mode disabled'); });

    // Analytics
    let respChart, statusChart, rrChart, devChart, audChart;

    function renderDashboard(){
      fetch('/api/dashboard')
        .then(response => response.json())
        .then(data => {
          $('#kpi-surveys').textContent = String(data.surveyCount);
          $('#kpi-responses').textContent = String(data.responseCount);
          $('#kpi-completion').textContent = data.completionRate + '%'; 
          $('#completion-progress').style.width = data.completionRate + '%';
          $('#kpi-active').textContent = String(data.activeSurveys);

          // Status pie
          if(data.statusChart) {
            const statusCounts = data.statusChart;
            if(statusChart) statusChart.destroy();
            const hasStatus = statusCounts.some(v=>v>0);
            $('#empty-status').classList.toggle('hidden', hasStatus);
            if(hasStatus){
              statusChart = new Chart($('#chart-status'), { type:'doughnut', data:{ labels:['Active','Paused','Draft'], datasets:[{ data:statusCounts }]}, options:{ responsive:true, plugins:{legend:{display:true}} }});
            }
          }

          // Responses line
          if(data.responsesOverTime) {
            const labels = data.responsesOverTime.labels;
            const series = data.responsesOverTime.data;
            $('#empty-responses').classList.toggle('hidden', series.some(x=>x>0));
            if(respChart) respChart.destroy();
            if(series.some(x=>x>0)) respChart = new Chart($('#chart-responses'), { type:'line', data:{ labels, datasets:[{ label:'Responses', data:series, tension:.3, fill:true }] }, options:{ responsive:true, plugins:{legend:{display:false}} }});
          }
        });
    }

    $$('.range-btn').forEach(b=> b.addEventListener('click',()=> showToast('Range switch (demo)')));

    function renderSurveys(){
      fetch('/api/surveys')
        .then(response => response.json())
        .then(surveys => {
          const list = $('#surveys-list');
          if(surveys.length===0){ 
            list.className='empty p-6 text-ink-400 text-center'; 
            list.innerHTML = `
              <i class="fa-solid fa-square-poll-vertical text-3xl mb-3 opacity-50"></i>
              <p>${I18N[currentLang()].no_surveys}</p>
              <p class="text-sm mt-2">${I18N[currentLang()].start_create}</p>
              <button class="btn btn-primary mt-4" id="cta-create"><i class="fa-solid fa-plus"></i> ${I18N[currentLang()].create_survey}</button>`;
            $('#cta-create')?.addEventListener('click', openCreate); 
            return; 
          }

          list.className='grid gap-4 md:grid-cols-2';
          list.innerHTML = '';
          surveys.forEach(s=>{
            const card = document.createElement('div'); card.className='card p-5';
            card.innerHTML = `
              <div class='flex items-start justify-between'>
                <div>
                  <div class='text-xs text-ink-400'>${new Date(s.created).toLocaleString()}</div>
                  <h3 class='text-lg font-semibold mt-1'>${s.title}</h3>
                  <div class='text-xs mt-1'>Questions: ${s.questions.length}</div>
                </div>
                <span class='px-2 py-1 text-xs rounded bg-white/10'>${s.status||'active'}</span>
              </div>
              <div class='mt-4 flex gap-2 flex-wrap'>
                <button class='btn btn-ghost edit' data-id='${s.id}'><i class="fa-regular fa-pen-to-square"></i> Edit</button>
                <button class='btn btn-ghost duplicate' data-id='${s.id}'><i class="fa-regular fa-copy"></i> Duplicate</button>
                <button class='btn btn-ghost danger delete' data-id='${s.id}'><i class="fa-regular fa-trash-can"></i> Delete</button>
                <button class='btn btn-ghost toggle' data-id='${s.id}'>${s.status==='active'?'Pause':'Activate'}</button>
              </div>`;
            list.appendChild(card);
          });

          // Actions
          $$('.edit').forEach(b=> b.addEventListener('click',()=> loadSurvey(b.dataset.id)));
          $$('.delete').forEach(b=> b.addEventListener('click',()=>{ 
            const id=b.dataset.id; 
            fetch(`/api/surveys/${id}`, { method: 'DELETE' })
              .then(response => response.json())
              .then(data => {
                if(data.success) {
                  showToast('Deleted'); 
                  renderSurveys(); 
                  refreshAll();
                } else {
                  showToast('Error deleting survey');
                }
              });
          }));
          $$('.duplicate').forEach(b=> b.addEventListener('click',()=>{ 
            const id=b.dataset.id; 
            fetch(`/api/surveys/${id}/duplicate`, { method: 'POST' })
              .then(response => response.json())
              .then(data => {
                if(data.success) {
                  renderSurveys(); 
                  showToast('Duplicated');
                } else {
                  showToast('Error duplicating survey');
                }
              });
          }));
          $$('.toggle').forEach(b=> b.addEventListener('click',()=>{ 
            const id=b.dataset.id; 
            fetch(`/api/surveys/${id}/toggle`, { method: 'POST' })
              .then(response => response.json())
              .then(data => {
                if(data.success) {
                  renderSurveys(); 
                  refreshAll();
                } else {
                  showToast('Error toggling survey status');
                }
              });
          }));

          // Search
          $('#survey-search').addEventListener('input', e=>{
            const q = e.target.value.toLowerCase();
            $$('#surveys-list .card').forEach(c=> c.classList.toggle('hidden', !c.textContent.toLowerCase().includes(q)));
          });
        });
    }

    function loadSurvey(id){
      fetch(`/api/surveys/${id}`)
        .then(response => response.json())
        .then(s => {
          if(!s) return; 
          routeTo('builder'); 
          emptyCanvas(); 
          $('#builder-title').value = s.title; 
          editingSurveyId = s.id;
          s.questions.forEach(q=>{ 
            const c = componentCard(q.type); 
            c.querySelector('input.field').value = q.label; 
            c.querySelector('.req').checked = !!q.required; 
            if(q.options){ 
              const ed = c.querySelector('.settings'); 
              ed.innerHTML=''; 
              const ed2 = optionsEditor(); 
              ed.appendChild(ed2); 
              const holder = ed2.querySelector('.add-opt'); 
              q.options.forEach((opt,i)=>{ 
                if(i===0){ 
                  ed2.querySelector('.option-row input').value = opt; 
                } else { 
                  holder.click(); 
                  ed2.querySelectorAll('.option-row input')[i].value = opt; 
                } 
              }); 
            } 
            if(q.max && c.querySelector('input.max')) c.querySelector('input.max').value = q.max; 
            if(q.min && c.querySelector('input.min')) c.querySelector('input.min').value = q.min; 
            if(q.accept && c.querySelector('input[type=text]')) c.querySelector('input[type=text]').value = q.accept; 
            canvas.appendChild(c); 
          });
          showToast('Loaded in builder');
        });
    }

    // Audience
    $('#add-contact').addEventListener('click',()=>{
      const name = prompt('Name'); if(!name) return; const email = prompt('Email'); if(!email) return; const group = prompt('Group (optional)')||'';
      fetch('/api/contacts', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name, email, group, status:'active' })
      })
      .then(response => response.json())
      .then(data => {
        if(data.success) {
          renderAudience(); 
          showToast('Contact added');
        } else {
          showToast('Error adding contact');
        }
      });
    });

    function renderAudience(){
      fetch('/api/contacts')
        .then(response => response.json())
        .then(c => {
          const t = $('#audience-table'); 
          $('#kpi-contacts').textContent = c.length;
          $('#kpi-contacts-active').textContent = c.filter(x=>x.status==='active').length;
          $('#kpi-contacts-unsub').textContent = c.filter(x=>x.status==='unsub').length;
          $('#kpi-contacts-groups').textContent = new Set(c.map(x=>x.group).filter(Boolean)).size;

          if(c.length===0){ 
            t.innerHTML = `<tr><td colspan='5' class='text-center py-8 text-ink-400'><i class="fa-solid fa-address-book text-3xl mb-3 opacity-50"></i><span>${I18N[currentLang()].no_contacts}</span></td></tr>`; 
            $('#empty-ag').classList.remove('hidden'); 
            if(audChart) audChart.destroy(); 
            return; 
          }

          t.innerHTML = c.map(x=> `<tr class='border-b border-white/5'><td class='py-2'>${x.name}</td><td>${x.email}</td><td>${x.group||'-'}</td><td>${x.status}</td><td>${new Date(x.lastActivity).toLocaleString()}</td></tr>`).join('');

          // Growth chart (last 30 days)
          const labels = Array.from({length: 30}).map((_,i)=>{ const d=new Date(); d.setDate(d.getDate()-(29-i)); return d.toISOString().slice(0,10); });
          const counts = labels.map(day=> c.filter(x=> x.lastActivity.slice(0,10)===day).length).map((v,i,arr)=> arr.slice(0,i+1).reduce((a,b)=>a+b,0));
          $('#empty-ag').classList.add('hidden');
          if(audChart) audChart.destroy();
          audChart = new Chart($('#chart-audience-growth'), { type:'line', data:{ labels, datasets:[{ label:'Contacts', data:counts, tension:.3, fill:true }]}, options:{ plugins:{legend:{display:false}} }});
        });
    }

    // Charts on Analytics page
    function renderAnalytics(){
      fetch('/api/analytics')
        .then(response => response.json())
        .then(data => {
          const surveys = data.surveys || [];
          const responses = data.responses || [];
          
          // Populate survey selector
          const sel = $('#analytics-survey'); 
          sel.innerHTML = surveys.map(s=>`<option value='${s.id}'>${s.title}</option>`).join('');
          if(!surveys.length){ sel.innerHTML = '<option>(no surveys)</option>'; }

          const has = responses.length>0;
          $('#empty-rr').classList.toggle('hidden', has);
          $('#empty-db').classList.toggle('hidden', has);
          if(rrChart) rrChart.destroy(); if(devChart) devChart.destroy();
          if(!has) return;

          // Response rate (by day)
          if(data.responseRate) {
            const labels = data.responseRate.labels;
            const counts = data.responseRate.data;
            rrChart = new Chart($('#chart-response-rate'), { type:'bar', data:{ labels, datasets:[{ label:'Responses', data:counts }]}, options:{ plugins:{legend:{display:false}} }});
          }

          // Device breakdown
          if(data.deviceBreakdown) {
            const devices = Object.keys(data.deviceBreakdown);
            const dcounts = Object.values(data.deviceBreakdown);
            devChart = new Chart($('#chart-device-breakdown'), { type:'pie', data:{ labels:devices, datasets:[{ data:dcounts }]}});
          }

          // Table
          const tbody = $('#responses-table');
          const grouped = surveys.map(s=>{
            const rs = responses.filter(r=>r.surveyId===s.id);
            const completed = rs.filter(r=>r.completed).length;
            const rate = rs.length? Math.round((completed/rs.length)*100) : 0;
            const avgTime = rs.length? (Math.round((rs.reduce((a,_r)=>a+(30+Math.random()*60),0)/rs.length)))+'s' : '-';
            return `<tr class='border-b border-white/10'><td class='py-2'>${s.title}</td><td>${rs.length}</td><td>${rate}%</td><td>${avgTime}</td><td>${s.status||'active'}</td></tr>`;
          }).join('');
          tbody.innerHTML = grouped || `<tr><td colspan='5' class='text-center py-8 text-ink-400'><i class="fa-solid fa-table text-3xl mb-3 opacity-50"></i><span>${I18N[currentLang()].no_resp}</span></td></tr>`;
        });
    }

    // Simulate responses (demo to power charts)
    $('#simulate-responses').addEventListener('click',()=>{
      const surveyId = $('#analytics-survey').value;
      if(!surveyId) { showToast('Select a survey first'); return; }
      
      fetch(`/api/surveys/${surveyId}/simulate`, { method: 'POST' })
        .then(response => response.json())
        .then(data => {
          if(data.success) {
            showToast('Responses simulated'); 
            refreshAll(); 
            routeTo('analytics');
          } else {
            showToast('Error simulating responses');
          }
        });
    });

    // Settings
    $('#btn-2fa').addEventListener('click',()=>{ const code = Math.floor(100000+Math.random()*900000); prompt('Scan your app then enter this code to confirm 2FA (demo):', code); showToast('2FA enabled (demo)'); });

    $('#save-profile').addEventListener('click',()=>{
      const profile = { name: $('#profile-name').value, email: $('#profile-email').value, tz: $('#profile-tz').value };
      fetch('/api/profile', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(profile)
      })
      .then(response => response.json())
      .then(data => {
        if(data.success) {
          showToast('Profile saved');
        } else {
          showToast('Error saving profile');
        }
      });
    });

    $('#pref-compact').addEventListener('change', e=>{ document.body.classList.toggle('text-[15px]', e.target.checked); });
    $('#pref-dark').addEventListener('change', e=>{ document.documentElement.classList.toggle('dark', e.target.checked); });
    $('#pref-email').addEventListener('change', e=>{ showToast('Email notifications '+(e.target.checked?'on':'off')); });

    // Global search (quick filter on surveys)
    $('#global-search').addEventListener('input', e=>{
      const q = e.target.value.toLowerCase();
      if($('#route-surveys').classList.contains('hidden')) routeTo('surveys');
      $$('#surveys-list .card').forEach(c=> c.classList.toggle('hidden', !c.textContent.toLowerCase().includes(q)));
    });

    // Initial load
    function refreshAll(){ renderDashboard(); renderSurveys(); renderAnalytics(); renderAudience(); }

    function init(){
      // Check if user is logged in
      fetch('/api/user')
        .then(response => response.json())
        .then(user => {
          if(user && user.id) {
            $('#auth').classList.add('hidden'); 
            $('#app').classList.remove('hidden'); 
            routeTo('dashboard'); 
            refreshAll();
            
            // Load profile data
            $('#profile-name').value = user.name || '';
            $('#profile-email').value = user.email || '';
          } else {
            $('#auth').classList.remove('hidden'); 
            $('#app').classList.add('hidden');
          }
        })
        .catch(() => {
          $('#auth').classList.remove('hidden'); 
          $('#app').classList.add('hidden');
        });
        
      applyI18n(currentLang());
      if(JSON.parse(localStorage.getItem('scp_gov')||'false')) setGovMode(true); else setGovMode(false);
      draggableSetup();
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
